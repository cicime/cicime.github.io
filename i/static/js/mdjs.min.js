window.Mdjs={regs:{ul:/^[\*\-\+] +\S*/g,ol:/^\d+\. +\S*/g,delHTML:/<\/?[^<>]+>/g,url:/^\w+:\/{2,3}\S+$/g,email:/^[\w-]+@[\w-]+\.[\w\.-]+$/g},tbAlign:["left","mid","right"],tag:{tBlock:["<blockquote><p>","</p></blockquote>\n"],tCode:['<pre><code data-lang="$lang">',"</code></pre>\n"],tList:["<li>","<ol>","<ul>","</li>\n","</ol>\n","</ul>\n"],tP:["<p>","</p>"],tToc:['<div class="md_toc">\n',"<ol>\n",'<a href="#$href"><li>',"</li></a>","</ol>","</div>\n"],tFoot:['<div class="md_foot">\n<ol>\n','<li name="%s" id="%s" >',"</li>","</ol></div>\n"],tA:['<a href="mailto:','<a href="','">',"</a>"],tTable:['<table class="md_table">\n<thead>\n',"</thead>\n<tbody>\n","</tbody>\n</table>\n","<tr>","</tr>\n",'<th class="$align">',"</th>",'<td class="$align">',"</td>","md_table_"]},inlineTag:{tStrong:["<strong>","</strong>"],tEm:["<em>","</em>"],tCode:["<code>","</code>"],tSupStr:'<sup><a title="%s" href="%s">%s</a></sup>',tAStr:'<a title="%s" href="%s">%s</a>',tImgStr:'<img alt="%s" title="%s" src="%s" />'},initILT:function(){var t=Mdjs.inlineTag;t.tSup=t.tSupStr.split("%s"),t.tA=t.tAStr.split("%s"),t.tImg=t.tImgStr.split("%s")},_meaning:"#`*[]()-_{}+.!|\\",_inArray:function(t,e){for(var i=0;i<e.length;i++)if(t==e[i])return 1;return 0},_startWith:function(t,e){return t.length<e.length?!1:t.slice(0,e.length)==e},_endWith:function(t,e){return t.length<e.length?!1:t.slice(-e.length)==e},_isHr:function(t){var e=t[0];if("="!=e&&"-"!=e&&"_"!=e&&"*"!=e)return!1;for(var i=0,n=0;i<t.length;i++)if(" "!=t[i]&&"	"!=t[i]){if(t[i]!=e)return!1;n++}return n>=3},_isAList:function(t){return this._isHr(t)?0:-1!=t.search(this.regs.ol)?1:-1!=t.search(this.regs.ul)?2:0},_leftSpace:function(t){for(var e=0,i=0;i<t.length;i++)if(" "==t[i])e++;else{if("	"!=t[i])break;e+=4}return e},_genSpace:function(t){if(!this.gss){this.gss=" ";for(var e=0;10>e;e++)this.gss+=this.gss}return 0>=t?"":this.gss.slice(0,t)},_htmlSafer:function(t){var t=t.replace(/&/g,"&gt;");return t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g,"&nbsp;").replace(/\'/g,"&#39;").replace(/\"/g,"&quot;").replace(/\n/g,"</br>")},_matchHref:function(t){for(var e={},i=0,n=0;i<t.length;i++)if(n){if("'"==t[i]||'"'==t[i]||"("==t[i]){e.title=t.slice(i+1,-1);break}}else(" "==t[i]||"	"==t[i])&&(e.url=t.slice(0,i),n=1);return e.url||(e.url=t),e.title||(e.title=""),e},_matchRefer:function(t){t=t.trim();var e,i,n;return"["!=t[0]?0:-1==(e=t.indexOf("]:",1))?0:" "!=t[e+2]&&"	"!=t[e+2]?0:(i=t.slice(1,e),"^"==i[0]?(n={id:this.sup_record(i),title:i.slice(1),content:t.slice(e+3)},n.url="#md_f_"+n.id):n=this._matchHref(t.slice(e+3).trim()),this.refer_set(i,n),1)},_inn:[],_inn2:[],_innLen:0,_iTop:function(){return 0==this._innLen?-1:this._inn[this._innLen-1]},_iTop2:function(){return this._inn2[this._innLen-1]},_iPush:function(t,e){this._inn[this._innLen]=t,this._inn2[this._innLen++]=e},_iPop:function(){return 0==this._innLen?!1:(this._innLen--,!0)},refer_init:function(){this.rfMan={},this.rfSup=[]},refer_set:function(t,e){this.rfMan[t.toLowerCase()]=e},refer_get:function(t){return this.rfMan[t.toLowerCase()]},sup_record:function(t){return this.rfSup.push(t)},md2html:function(t,e){try{Mdjs.initILT(),Mdjs.refer_init();for(var i=[],n=null,r=0,s=0,a=t.length;a>r;r++,n=null)"\r"==t[r]?(n=t.slice(s,r),r+="\n"==t[r+1]?1:0):"\n"==t[r]&&(n=t.slice(s,r)),null!=n&&(Mdjs._matchRefer(n)||i.push(n),s=r+1);return a>s&&(n=t.slice(s),Mdjs._matchRefer(n)||i.push(n)),Mdjs.handlerLines(i)+Mdjs.handlerFoot()}catch(h){Toast.err("Mdjs运行时错误:<br/><strong>"+h+'</strong><br />欢迎来此报告错误:<br />(下面两个链接任意一个均可)<br /><a target="_blank" href="http://git.oschina.net/voyageliu/mdjs/issues">Git@OSC</a><br /><a target="_blank" href="http://git.oschina.net/voyageliu/mdjs/issues">Github</a>')}},handlerLines:function(t,e){for(var i="",n=0,r="",s=0,a=[],h=[],l=-1,f=[],g=[],o=0,c=-2,u="",d=0;d<t.length;d++)if(r=t[d].trim(),n>0){if("```"==r){n=0,i+=this.tag.tCode[1];continue}i+=(1==n?"":"\n")+this._htmlSafer(t[d]),n++}else{s=this._leftSpace(t[d]);var _=this._isAList(r);if(0==_)if(i+=this.handlerListEnd(),0!=r.length){if(4>s){if("```"==r.slice(0,3)){lang=r.slice(3).trim(),i+=this.tag.tCode[0].replace("$lang",lang),n=1;continue}for(var b=0;b<r.length&&"#"==r[b];b++);if(0!=b){for(var p=r.length-1;p>b&&"#"==r[p];p--);var m=r.slice(b,p+1),T=m=this.handlerInline(m,0);g[o]=b,f[o++]=T=T.trim().replace(this.regs.delHTML,""),i+="<h"+b+' id="'+T+'" name="'+T+'">'+m+"</h"+b+">\n";continue}if(">"==r[0]&&r.length>1){var v=[];v.push(r.slice(1));for(var L=d+1;L<t.length&&(u=t[L].trim(),0!=u.length);L++){if(">"==u[0])u=u.slice(1);else if(e)break;v.push(u)}i+=this.tag.tBlock[0]+this.handlerLines(v,!0)+this.tag.tBlock[1],d=L-1;continue}if(this._isHr(r)){i+="<hr />";continue}if("[TOC]"==r){l=i.length;continue}if(0!=(a=this.handlerTbLine(r))&&d<t.length-1&&0!=(h=this.handlerTbFmt(t[d+1].trim(),a.length))){i+=this.tag.tTable[0]+this.tag.tTable[3]+this.genTbTr(a,h,!0)+this.tag.tTable[4],i+=this.tag.tTable[1];for(var b=d+2;b<t.length&&0!=(a=this.handlerTbLine(t[b].trim()));b++)i+=this.tag.tTable[3]+this.genTbTr(a,h,!1)+this.tag.tTable[4];d=b-1,i+=this.tag.tTable[2];continue}}else if(0==d||0==t[d-1].trim().length){i+=this.tag.tCode[0].replace("$lang","");for(var S,k="",A=d,b=d;b<t.length;b++)if(0!=t[b].trim().length){if((S=this._leftSpace(t[b]))<4)break;i+=k+(b==d?"":"\n")+this._genSpace(S-2)+this._htmlSafer(t[b].trim()),k="",A=b}else k+="\n";i+=this.tag.tCode[1],d=A;continue}if(d+1<t.length&&(u=t[d+1].trim(),this._isHr(u))){var I=3;"="==u[0]?I=1:"-"==u[0]&&(I=2);var T=m=this.handlerInline(r,0);g[o]=I,f[o++]=T=T.trim().replace(this.regs.delHTML,""),i+="<h"+I+' id="'+T+'" name="'+T+'">'+m+"</h"+I+">\n",d++}else u=this.handlerInline(r,0).trim(),i+=this._startWith(u,"<img ")&&this._endWith(u,"/>")&&-1==u.indexOf("<img ",1)?u:this.tag.tP[0]+u+this.tag.tP[1]}else c!=d-1&&(i+="<br />\n"),c=d;else i+=this.handlerList(s,_,r)}if(-1!=l){var M=i.slice(0,l);i=i.slice(l),i=M+this.handlerTOC(f,g,o)+i}return i},handlerFoot:function(){if(0==this.rfSup.length)return"";for(var t=this.tag.tFoot,e=t[0],i=0;i<this.rfSup.length;i++){var n=this.refer_get(this.rfSup[i]);e+=t[1].replace(/%s/g,n.url.slice(1))+this.handlerInline(n.content,0)+t[2]}return e+t[3]},handlerTOC:function(t,e,i){for(var n,r=this.tag.tToc[0],s=[],a=0,h=0;i>h;h++)n=this.tag.tToc[2].replace("$href",t[h])+t[h]+this.tag.tToc[3],0==a||e[h]>s[a-1]?(r+=this.tag.tToc[1]+n,s[a++]=e[h]):e[h]==s[a-1]?r+=n:(r+=this.tag.tToc[4],a--,h--);for(;a-- >0;)r+=this.tag.tToc[4];return r+this.tag.tToc[5]},handlerListEnd:function(){for(var t="";-1!=this._iTop();)t+=1==this._iTop2()?this.tag.tList[4]:this.tag.tList[5],this._iPop();return t},handlerList:function(t,e,i){var n=this._iTop(),r=this.tag.tList[0]+this.handlerInline(i,i.indexOf(" "),0)+this.tag.tList[3],s="";if(t>n)return this._iPush(t,e),this.tag.tList[e]+r;if(t==n)return r;for(;n>t;)s+=1==this._iTop2()?this.tag.tList[4]:this.tag.tList[5],this._iPop(),n=this._iTop();return-1==n?(this._iPush(t,e),s+this.tag.tList[e]+r):s+r},genTbTr:function(t,e,i){for(var n="",r=0;r<t.length;r++)n+=this.tag.tTable[i?5:7].replace("$align",this.tag.tTable[9]+this.tbAlign[e[r]])+this.handlerInline(t[r],0)+this.tag.tTable[i?6:8];return n},handlerTbFmt:function(t,e){var i=this.handlerTbLine(t,!0),n=[],r=0,s=0;if(0==i)return!1;for(var a=i.length;a>r;r++,s=0)i[r].length<=1?n[r]=0:(":"==i[r][i[r].length-1]&&(s=":"==i[r][0]?1:2),n[r]=s);for(;e>r;r++)n[r]=0;return n},handlerTbLine:function(t,e){var i=[],n=t.length,r="";void 0==e&&(e=!1);for(var s="|"==t[0]?1:0;n>s;s++){switch(t[s]){case"\\":if(e)return!1;r+="\\","|"==t[s+1]&&(r+="|",s++);continue;case"|":if(r=r.trim(),e&&0==r.length)return!1;i.push(r),r="";continue}if(e&&":"!=t[s]&&"-"!=t[s]&&" "!=t[s]&&"	"!=t[s])return!1;r+=t[s]}return 0==i.length&&"|"!=t[0]?!1:(r=r.trim(),0!=r.length&&i.push(r),i)},handlerInline:function(t,e){for(var i,n,r,s,a,h,l,f,g,o,c=t.length,u=[],d="",_=-1,b=-1,p=-1,m=-1,T=-1,v="*",L="*",S=this.inlineTag,k=e?e:0;c>k;k++)switch(t[k]){case"\\":this._inArray(t[k+1],this._meaning)&&(_=u.length,b=++k),d+=t[k];break;case"`":l="`"==t[k+1]?"``":"`",f=l.length,-1==(i=t.indexOf(l,k+f))?d+=l:(d+=S.tCode[0]+this._htmlSafer(t.slice(k+f,i))+S.tCode[1],k=i),k+=f-1;break;case"~":"~"==t[k+1]?(T>=0?""==d?u[T]+="~~":(u[T]+="<del>",d+="</del>",T=-1):(T=u.push(d)-1,d=""),k++):d+="~";break;case"*":case"_":if(!(" "!=t[k+1]&&"	"!=t[k+1]||" "!=t[k-1]&&"	"!=t[k-1])){d+=t[k];break}if(t[k+1]==t[k]){if(p>=0){if(v!=t[k]){d+=t[k++]+t[k];break}u[p]+=S.tStrong[0],d+=S.tStrong[1],p=-1}else t[k+2]==t[k]&&t[k+3]==t[k]&&(d+=t[k++]+t[k++]),p=u.push(d)-1,d="",v=t[k];k++}else if(m>=0){if(L!=t[k]){d+=t[k];break}u[m]+=S.tEm[0],d+=S.tEm[1],m=-1}else m=u.push(d)-1,d="",L=t[k];break;case">":d+=k>=2&&"--"==t.slice(k-2,k)?"-->":">";break;case"<":if("!--"==t.slice(k+1,k+4)){d+="<!--";break}for(o=1,i=k+1;c>i&&">"!=t[i];i++)(" "==t[i]||"	"==t[i])&&(o=0);if(i>=c){d+="&lt;";break}if(l=t.slice(k+1,i),o){if(this.regs.url.test(l)){d+=this.tag.tA[1]+l+this.tag.tA[2]+l+this.tag.tA[3],k=i;break}if(this.regs.email.test(l)){d+=this.tag.tA[0]+l+this.tag.tA[2]+l+this.tag.tA[3],k=i;break}}d+="<";break;case"!":"["!=t[k+1]&&(d+="!");break;case"[":n="!"!=t[k-1]||_==u.length&&b==k-1?"^"==t[k+1]?"s":"":"i";for(var A=0,I=k+1,M=0;c>I;I++)switch(t[I]){case"!":if("["!=t[I+1])break;""!=n?I=c:(A=1,I++);break;case"`":l="`"==t[I+1]?"``":"`",f=l.length,-1==(i=t.indexOf(l,I+f))?I+=f-1:I=i+f-1;break;case"[":I=c;break;case"]":if(r=t.slice(k+1,I),"s"==n){g=this.refer_get(r),g&&(d+=S.tSup[0]+g.title+S.tSup[1]+g.url+S.tSup[2]+g.id+S.tSup[3],M=1,k=I,I=c);break}l=t[I+1];var C;if("("==l)C=")";else{if("["!=l&&(" "!=l||"["!=t[I+2])){I=c;break}C="]"}if(f=" "==l?I+3:I+2,-1!=(i=t.indexOf(C,f))){if(A){A=0;break}if(s=t.slice(f,i).trim(),"]"==C){if(0==s.length&&(s=r),g=this.refer_get(s),!g){I=c;break}}else g=this._matchHref(s);a=g.url,h=g.title,d+="i"==n?S.tImg[0]+this._htmlSafer(r)+S.tImg[1]+this._htmlSafer(h)+S.tImg[2]+encodeURI(a)+S.tImg[3]:S.tA[0]+this._htmlSafer(h)+S.tA[1]+encodeURI(a)+S.tA[2]+this.handlerInline(r,0)+S.tA[3],M=1,k=i}I=c}if(!M&&I>=c)switch(n){case"s":d+="[^",k++;break;case"i":d+="![";break;default:d+="["}break;default:d+=t[k]}return u.push(d),-1!=T&&(u[T]+="~~"),-1!=p&&(u[p]+=v+v),-1!=m&&(u[m]+=L),u.join("")}};